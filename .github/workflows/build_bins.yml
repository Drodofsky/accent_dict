name: Build accent_dict binaries

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
          - os: windows-latest
          - os: macos-latest 
          - os: macos-13

    env:
      # tell pyo3 we're building a Python extension module
      PYO3_BUILD_EXTENSION_MODULE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # Linux + Windows
      - name: Build with cargo (non-macOS)
        if: runner.os != 'macOS'
        run: cargo build --release

      # macOS (Intel + ARM)
      - name: Build with cargo (macOS)
        if: runner.os == 'macOS'
        run: |
          export RUSTFLAGS="-C link-arg=-undefined -C link-arg=dynamic_lookup"
          cargo build --release


      - name: Collect built binary
        shell: bash
        run: |
          mkdir -p dist
          case "${{ runner.os }}" in
            Linux)
              # target/release/libaccent_dict.so -> accent_dict.linux-x86_64.so
              cp target/release/libaccent_dict.so dist/accent_dict.linux-x86_64.so
              ;;
            macOS)
              # target/release/libaccent_dict.dylib -> accent_dict.macos-$(arch).so
              arch="$(uname -m)"
              cp target/release/libaccent_dict.dylib "dist/accent_dict.macos-${arch}.so"
              ;;
            Windows)
              # target\release\accent_dict.dll -> accent_dict.windows-x86_64.pyd
              cp target/release/accent_dict.dll dist/accent_dict.windows-x86_64.pyd
              ;;
          esac

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: accent_dict-${{ matrix.os }}
          path: dist/*
  package:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all built binaries
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare addon directory
        run: |
          # Create working directory
          mkdir -p addon_out
          cp -r accent_dict_jp/* addon_out/

          # Copy binaries from all artifacts (wildcard = robust)
          cp artifacts/accent_dict-ubuntu-latest/*.so addon_out/
          cp artifacts/accent_dict-windows-latest/*.pyd addon_out/
          cp artifacts/accent_dict-macos-latest/*.so addon_out/
          cp artifacts/accent_dict-macos-14/*.so addon_out/

          cd addon_out
          zip -r ../accent_dict_jp.ankiaddon *


      - name: Upload combined addon zip
        uses: actions/upload-artifact@v4
        with:
          name: accent_dict-anki-addon
          path: accent_dict_jp.ankiaddon

